# Docker Compose configuration for Vite React application
#version: '3.8'

services:
  # Main React application service
  react-app:
    # Build from local Dockerfile
    build:
      context: .
      dockerfile: Dockerfile
      target: production # Use production stage from multi-stage build

    # Container name for easier management
    container_name: matt-apps

    # Environment variables
    environment:
      - NODE_ENV=production

    # Restart policy for production reliability
    restart: unless-stopped

    # Health check configuration
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource limits for container security and stability
    deploy:
      resources:
        limits:
          cpus: '0.5' # Limit to 0.5 CPU cores
          memory: 256M # Limit to 256MB RAM
        reservations:
          cpus: '0.25' # Reserve 0.25 CPU cores
          memory: 128M # Reserve 128MB RAM

    # Security options
    security_opt:
      - no-new-privileges:true # Prevent privilege escalation

    # Read-only root filesystem for security (with tmpfs for writable areas)
    read_only: true
    tmpfs:
      - /var/cache/nginx:rw,noexec,nosuid,size=50m
      - /var/log/nginx:rw,noexec,nosuid,size=50m
      - /var/run:rw,noexec,nosuid,size=50m

    # Labels for container management and monitoring
    labels:
      - "traefik.enable=true" # Enable if using Traefik reverse proxy
      - "traefik.http.routers.react-app.rule=Host(`localhost`)"
      - "com.docker.compose.project=coolify-front"

    # Networks
    networks:
      - frontend

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Network configuration
networks:
  frontend:
    driver: bridge
    # Enable IPv6 support
    enable_ipv6: false
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16

# Optional: Volumes for persistent data
volumes:
  nginx_cache:
    driver: local
